<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
    body {
        font-family: Arial;
        font-size: 20px;
    }

    h1 { 
  	display: block;
  	font-size: 2em;
  	margin-top: 1.5em;
  	margin-bottom: 1em;
  	margin-left: 0;
  	margin-right: 0;
  	font-weight: bold;
    }
    
    h2 { 
  	display: block;
  	font-size: 1em;
  	margin-top: 0.67em;
  	margin-bottom: 0.67em;
  	margin-left: 0;
  	margin-right: 0;
  	font-weight: bold;
    }
    </style>
</head>

<body>
<h1>
    Fourier transzformált giroszkóp adat
</h1>
<h2>
    <a href="raw.html" class="button">Nyers adat</a>
</h2>
<pre class="output">
    alpha:
    beta:
    gamma:
    fps:
</pre>



<script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.15.1/dist/tf.min.js"></script>
<script>
    var xs = [0];
    var ys = [0];
    var zs = [0];
    var ii = 0;
    let permissionGranted = false
    let nonios13device = false
    let cx, cy
    
    function setup() {
        createCanvas(512, 256);
        noFill();
	cx = width / 2
 	cy = height / 2
	    
	//Request sensor access on iOS 13 devices
	if (typeof(DeviceMotionEvent) !== 'undefined' && typeof(DeviceMotionEvent.requestPermission) === 'function') {
		DeviceMotionEvent.requestPermission()
                .catch(() => {
                //Show permission dialog only the first time
        	let askButton = createButton("Allow acess to sensors")
        	askButton.style("font-size", "24px")
        	askButton.position(0, 0)
        	askButton.mousePressed(onAskButtonClicked)
        	throw error
      	})
      	.then(() => {
	//This runs on subsequent visits
        permissionGranted = true
      	})
  	} else {
    	text("non ios 13 devices", 50, 50)
    	nonios13device = true
    	permissionGranted = true
  	}
    }

    //Handle first time visiting to grant access
    function onAskButtonClicked() {
    DeviceMotionEvent.requestPermission().then(response => {
    if (response === 'granted') {
      permissionGranted = true
    } else {
      permissionGranted = false
    }
    this.remove()
    }).catch(console.error)
    }
    
    window.addEventListener('devicemotion', function(event) {
        var output = document.querySelector('.output');
        //console.log(event.acceleration.x + ' m/s2');
	//console.log(event.acceleration.y + ' m/s2');
	//console.log(event.acceleration.z + ' m/s2');
        console.log(event.interval);
        var x = event.acceleration.x//event.rotationRate.alpha;  // In degree in the range [-180,180]
        var y = event.acceleration.y//event.rotationRate.beta;
        var z = event.acceleration.z//event.rotationRate.gamma;
        var fps = event.interval;
        xs.push(x);
        ys.push(y);
        zs.push(z);
        if (xs.length > 512) {
            var tmp = xs.shift();
            tmp = ys.shift();
            tmp = zs.shift();
        }
        console.log([x,y,z]);
        function movingAvg(array, count, qualifier){

            // calculate average for subarray
            var avg = function(array, qualifier){

                var sum = 0, count = 0, val;
                for (var i in array){
                    val = array[i];
                    if (!qualifier || qualifier(val)){
                        sum += val;
                        count++;
                    }
                }

                return sum / count;
            };

            var result = [], val;

            // pad beginning of result with null values
            for (var i=0; i < count-1; i++)
                result.push(null);

            // calculate average for each subarray and add to result
            for (var i=0, len=array.length - count; i <= len; i++){

                val = avg(array.slice(i, i + count), qualifier);
                if (isNaN(val))
                    result.push(null);
                else
                    result.push(val);
            }

            return result;
        }
        //https://stackoverflow.com/questions/19981713/html5-js-chart-with-moving-average
        function plot(data, col) {
            strokeWeight(3);
            stroke(col[0], col[1], col[2]);
            beginShape(LINES);
            const real = tf.tensor(data);
            const imag = tf.zeros([data.length]);
            const input = tf.complex(real, imag);
            const res = tf.spectral.fft(input);
            let a = res.abs().print()
            console.log(a);
            for (i = 0; i < data.length; i++) {
                //fill(237, 34, 93);
                //noStroke();
                vertex(i, map(data[i]+180, 0, 255, height, 0));
            }
            endShape();
        }
        function plot2(data, col) {
            stroke(3);
            // draw lines
            const dotLayer = tf.layers.dot({axes: -1});
            let px = 0;
            let py = data[0];
            stroke(col[0], col[1], col[2]);
            const real = tf.tensor(data);
            const imag = tf.zeros([data.length]);
            const input = tf.complex(real, imag);
            const res = tf.spectral.fft(input);
            const kernel = tf.ones([20]);
            let a = res.abs().arraySync();
            console.log(a);
            a = movingAvg(a, 10)
            for(let i =0; i < a.length/2; i++){
                let x = i*2;
                let y = -(a[i])+253;
                //console.log((data[i])*128/Math.max(...data)+128)
                line(px, py, x, y);

                //store the last position
                px = x;
                py = y;
        }}
        function draw() {
            background(200);
            plot2(xs, [100,100,100]);
            plot2(ys, [0,200,100]);
            plot2(zs, [100, 0,200]);
            //let spectrum = fft.analyze();
	    
	    cx += map(rotationY, -90, 90, -100, 100)
  	    cy += map(rotationX, -90, 90, -100, 100)
  	    if (cx >= width) cx = 0
            else if (cx <= 0) cx = width
            if (cy >= height) cy = 0
            else if (cy <= 0) cy = height

            const pulse = sin(frameCount / 20) * 50
            fill(sin(frameCount/60) * 30 + 30, 100, 100)
            ellipse(cx, cy, 100 + abs(rotationX*20) + pulse, 100 + abs(rotationX*20) + pulse)


        }
        if (ii % 200 == 199){
            draw();
        }
        ii += 1;

        //updateChart();
        //var arr = [1, 2, 3, 4];
        //var theRemovedElement = arr.shift(); // theRemovedElement == 1
        //console.log(arr); // [2, 3, 4]
        output.innerHTML  = "alpha : " + z + "\n";
        output.innerHTML  += "beta : " + x + "\n";
        output.innerHTML += "gamma: " + y + "\n";
        output.innerHTML += "fps: " + 1000/fps + "\n";

    });
</script>
</body>


<!--
<script>
//Check if device is iOS 13
//Button is visible for every device though
function check() {
    var match = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/),
        version;

    if (match !== undefined && match !== null) {
        version = [
            parseInt(match[1], 10),
            parseInt(match[2], 10),
            parseInt(match[3] || 0, 10)
        ];
        ver=parseFloat(version.join('.'));
	if (ver < 13) {
            document.getElementById('request').style.visibility = 'visible';
        } else {
            document.getElementById('request').style.visibility = 'visible';
        }

    }
    else {
	document.getElementById('request').style.visibility = 'visible';
	}
}
</script>



<script>
//Make it https
  if (location.protocol != 'https:') {
   location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
  }

//Request permission
function requestT () {
      if (typeof(DeviceMotionEvent) !== 'undefined' && typeof(DeviceMotionEvent.requestPermission) === 'function') {
          DeviceMotionEvent.requestPermission()
          .then(response => {
	  alert('Orientation tracking '+ response);
		  
            if (response == 'granted') {
	    	document.getElementById('request').style.visibility='hidden';
            	// window.addEventListener('devicemotion', (e) => {
            	//  })
            }
          })
          .catch(console.error)
      }else {
          alert('DeviceMotionEvent is not defined');
      }

  }
  document.getElementById('request').onclick = requestT;
  </script>
-->


</html>


